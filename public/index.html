<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockchain Voting App</title>
</head>
<body>
    <h1>Voting App en Blockchain</h1>
    <button onclick="vote(true)">Votar Sí</button>
    <button onclick="vote(false)">Votar No</button>
    <p id="message"></p>
    <p>Votos a favor: <span id="yesVotes">0</span></p>
    <p>Votos en contra: <span id="noVotes">0</span></p>

    <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
    <script>
        const contractAddress = "0xd6DfC5DD49E8A0185b9501A8d238945cD34A88B5";
        const contractABI = [ [
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "voter",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "vote",
				"type": "bool"
			},
			{
				"indexed": false,
				"internalType": "bytes32",
				"name": "signatureHash",
				"type": "bytes32"
			}
		],
		"name": "Voted",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "getVoteCounts",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "hasVoted",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "noVotes",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bool",
				"name": "_vote",
				"type": "bool"
			},
			{
				"internalType": "bytes32",
				"name": "_signatureHash",
				"type": "bytes32"
			}
		],
		"name": "vote",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "voteSignatureHash",
		"outputs": [
			{
				"internalType": "bytes32",
				"name": "",
				"type": "bytes32"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "yesVotes",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
] ];

        async function vote(choice) {
            if (typeof window.ethereum === 'undefined') {
                alert("MetaMask no está instalado");
                return;
            }

            const provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            const signer = provider.getSigner();
            const contract = new ethers.Contract(contractAddress, contractABI, signer);

            const voteMessage = JSON.stringify({ vote: choice ? "yes" : "no" });
            const signature = await signer.signMessage(voteMessage);
            const signatureHash = ethers.utils.id(signature);

            try {
                await contract.vote(choice, signatureHash);
                document.getElementById('message').textContent = `Voto registrado: ${choice ? "Sí" : "No"}`;
                fetchVotes();
            } catch (error) {
                console.error("Error al votar:", error);
                document.getElementById('message').textContent = "Error al procesar el voto.";
            }
        }

        async function fetchVotes() {
            try {
                const response = await fetch('/api/votes');
                const data = await response.json();
                document.getElementById('yesVotes').textContent = data.yesVotes;
                document.getElementById('noVotes').textContent = data.noVotes;
            } catch (error) {
                console.error("Error al obtener votos:", error);
            }
        }

        // Cargar votos al inicio
        fetchVotes();
    </script>
</body>
</html>
